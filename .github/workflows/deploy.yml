name: Deploy to AWS Amplify

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_USER_POOL_ID: ${{ secrets.NEXT_PUBLIC_USER_POOL_ID }}
          NEXT_PUBLIC_USER_POOL_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_USER_POOL_CLIENT_ID }}
          NEXT_PUBLIC_REGION: ${{ secrets.NEXT_PUBLIC_REGION }}

      - name: Deploy to Amplify
        if: github.event_name != 'pull_request'
        uses: aws-amplify/amplify-cli-action@v2
        with:
          amplify_command: publish
          amplify_app_id: ${{ secrets.AMPLIFY_APP_ID }}
          amplify_env_name: ${{ secrets.AMPLIFY_ENV_NAME || 'main' }}
          amplify_access_token: ${{ secrets.AMPLIFY_ACCESS_TOKEN }}

      - name: Get Amplify URL
        if: github.event_name != 'pull_request' && success()
        id: amplify-url
        run: |
          # Intentar obtener la URL de Amplify
          if [ -n "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            # La URL generalmente es: https://main.{app-id}.amplifyapp.com
            # Pero necesitamos obtenerla del API de Amplify
            echo "url=https://main.${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Deployment successful**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.amplify-url.outputs.url }}" ]; then
            echo "### Amplify URL" >> $GITHUB_STEP_SUMMARY
            echo "- **URL:** ${{ steps.amplify-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Next step:** Update FRONTEND_URL in CDK stack:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   ./scripts/update-frontend-url.sh ${{ steps.amplify-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
            echo "   cd infrastructure && cdk deploy --context environment=dev" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          fi


